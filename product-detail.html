<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Detail</title>
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      background-color: #f4f5f7;
      margin: 0;
      padding: 1rem;
      display: flex;
      justify-content: center;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      max-width: 900px;
      width: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .card-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .image-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fafafa;
      width: 100%;
      padding: 1rem;
      box-sizing: border-box;
    }

    .image-wrapper img {
      width: 90%;
      max-width: 400px;
      aspect-ratio: 1 / 1;
      object-fit: contain;
      border-radius: 8px;
      transition: opacity 0.3s ease-in-out;
    }

    .details {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
    }

    .product-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
      color: #222;
      flex: 1;
    }

    .price {
      font-size: 1rem;
      font-weight: 600;
      color: #000;
      margin: 0;
      white-space: nowrap;
    }

    .section {
      margin-bottom: 0.6rem;
    }

    .section h4 {
      font-size: 0.85rem;
      margin-bottom: 0.3rem;
      font-weight: 600;
      color: #555;
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    /* Materials list style */
    #materialList {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      padding-left: 1rem;
      color: #444;
      font-size: 0.95rem;
      font-weight: 500;
    }

    /* Remove option-btn style for material items */
    #materialList > div {
      border: none;
      background: none;
      cursor: default;
      padding: 0;
      transform: none;
      box-shadow: none;
      color: #444;
    }

    .option-btn {
      border: 1px solid #ccc;
      padding: 0.35rem 0.9rem;
      border-radius: 6px;
      background: #fff;
      color: #333;
      cursor: pointer;
      font-size: 0.85rem;
      transition: border-color 0.2s, color 0.2s, transform 0.2s, box-shadow 0.2s;
      user-select: none;
    }

    .option-btn:hover {
      border-color: #888;
      color: #000;
      transform: scale(1.05);
    }

    .option-btn.active {
      border-color: #000;
      border-width: 2px;
      color: #000;
      font-weight: 600;
      transform: scale(1.08);
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }

    .action-buttons {
      display: flex;
      gap: 0.8rem;
      margin-top: 1rem;
    }

    .btn {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 48px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.3s, color 0.3s, transform 0.2s;
      box-sizing: border-box;
      border: none;
      user-select: none;
    }

    .btn-back {
      flex: 0 0 30%;
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
    }

    .btn-back:hover {
      background: #f5f5f5;
      border-color: #aaa;
    }

    .btn-proceed {
      flex: 0 0 70%;
      background: #000;
      color: #fff;
      padding: 0 20px;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .btn-proceed.enabled {
      cursor: pointer;
      opacity: 1;
    }

    .btn-proceed.enabled:hover {
      background: #222;
      transform: scale(1.02);
    }

    @media(min-width: 768px) {
      .card-content {
        flex-direction: row;
      }

      .image-wrapper {
        width: 50%;
        border-right: 1px solid #eee;
        padding: 1.5rem;
      }

      .image-wrapper img {
        width: 100%;
        max-width: 100%;
        aspect-ratio: 1 / 1;
      }

      .details {
        width: 50%;
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-content">
      <div class="image-wrapper">
        <img id="productImage" src="#" alt="Product Image"/>
      </div>
      <div class="details">
        <div class="product-header">
          <h1 class="product-title" id="productName"></h1>
          <p class="price">RM <span id="price">0.00</span></p>
        </div>

        <div class="section">
          <h4>Material Type</h4>
          <div class="options" id="typeOptions"></div>
        </div>

        <div class="section" id="materialSection" style="display:none;">
          <h4>Materials</h4>
          <div id="materialList"></div>
        </div>

        <div class="section" id="colorSection" style="display:none;">
          <h4>Colors</h4>
          <div class="options" id="colorOptions"></div>
        </div>

        <div class="section" id="hingesSection" style="display:none;">
          <h4>Door Hinges</h4>
          <div class="options" id="hingesOptions"></div>
        </div>

        <div class="section" id="slidesSection" style="display:none;">
          <h4>Drawer Slides</h4>
          <div class="options" id="slidesOptions"></div>
        </div>

        <div class="action-buttons">
          <a href="our-products.html" class="btn btn-back">&larr; Back</a>
          <a id="whatsappBtn" class="btn btn-proceed" href="#" target="_blank">Proceed to Order</a>
        </div>
      </div>
    </div>
  </div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');
  let productData = null;
  let optionsData = null;

  let selectedType = null;
  let selectedColor = null;
  let selectedHinge = null;
  let selectedSlide = null;

  async function fetchData() {
    const productRes = await fetch('products.json');
    const optionsRes = await fetch('options.json');
    const products = await productRes.json();
    optionsData = await optionsRes.json();

    productData = products.find(p => p.id === productId);
    if (!productData) {
      document.querySelector('.details').innerHTML = '<p>Product not found.</p>';
      return;
    }

    renderTypeOptions();
    if (productData.doorHinges) renderHinges();
    if (productData.drawerSlides) renderSlides();

    setDefaultSelections();
    updatePrice();
    validateProceedButton();
  }

  function renderTypeOptions() {
    const container = document.getElementById('typeOptions');
    container.innerHTML = '';
    const typeNameMap = {
      'type 1': 'Blockboard + Formica',
      'type 2': 'Melamine Chipboard'
    };
    ['type 1', 'type 2'].forEach(typeKey => {
      if (productData[typeKey]) {
        const btn = document.createElement('button');
        btn.textContent = typeNameMap[typeKey] || typeKey;
        btn.className = 'option-btn';
        btn.onclick = () => {
          const previousColor = selectedColor;
          selectedType = typeKey;
          highlightSelection(container, btn);
          renderMaterials(typeKey);
          renderColorOptions(typeKey, previousColor);
          updatePrice();
          validateProceedButton();
        };
        container.appendChild(btn);
      }
    });
  }

  function renderMaterials(typeKey) {
    const container = document.getElementById('materialList');
    container.innerHTML = '';
    document.getElementById('materialSection').style.display = 'block';

    const typeMaterials = productData[typeKey];
    for (const [key, val] of Object.entries(typeMaterials)) {
      if (key.toLowerCase().includes('color')) continue;
      const materialDiv = document.createElement('div');
      materialDiv.textContent = key;
      container.appendChild(materialDiv);
    }
  }

  function renderColorOptions(typeKey, previousColor = null) {
    const container = document.getElementById('colorOptions');
    container.innerHTML = '';
    document.getElementById('colorSection').style.display = 'block';

    const typeMaterials = productData[typeKey];
    let colorGroupName = Object.keys(typeMaterials).find(k => k.toLowerCase().includes('color'));
    if (!colorGroupName) {
      container.style.display = 'none';
      return;
    }

    const colorsObj = typeMaterials[colorGroupName];
    Object.keys(colorsObj).forEach(color => {
      const btn = document.createElement('button');
      btn.textContent = color;
      btn.className = 'option-btn';
      btn.onclick = () => {
        selectedColor = color;
        highlightSelection(container, btn);
        updatePrice();
        updateMainImage(color);
        validateProceedButton();
      };
      container.appendChild(btn);
    });

    if (previousColor && Object.keys(colorsObj).includes(previousColor)) {
      selectedColor = previousColor;
      setTimeout(() => {
        const btns = container.querySelectorAll('.option-btn');
        btns.forEach(btn => {
          if (btn.textContent === previousColor) btn.click();
        });
      }, 10);
    } else {
      selectedColor = Object.keys(colorsObj)[0];
      setTimeout(() => {
        container.querySelector('.option-btn').click();
      }, 10);
    }
  }

  function renderHinges() {
    const container = document.getElementById('hingesOptions');
    document.getElementById('hingesSection').style.display = 'block';
    const hingeValues = optionsData.doorHinges;
    const quantity = productData.doorHinges?.quantity ?? 1;

    const cheapestPrice = Math.min(...Object.values(hingeValues));

    Object.keys(hingeValues).forEach(type => {
      const basePrice = hingeValues[type];
      const diff = (basePrice - cheapestPrice) * quantity;
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.textContent = diff > 0
        ? `${type} (+RM${diff.toFixed(2)})`
        : `${type}`;
      btn.onclick = () => {
        selectedHinge = type;
        highlightSelection(container, btn);
        updatePrice();
        validateProceedButton();
      };
      container.appendChild(btn);
    });

    // Default select cheapest hinge
    const cheapestHinge = Object.entries(hingeValues).reduce((min, cur) => cur[1] < min[1] ? cur : min);
    selectedHinge = cheapestHinge[0];
    setTimeout(() => {
      const btns = container.querySelectorAll('.option-btn');
      btns.forEach(btn => {
        if (btn.textContent.startsWith(cheapestHinge[0])) btn.click();
      });
    }, 10);
  }

  function renderSlides() {
    const container = document.getElementById('slidesOptions');
    document.getElementById('slidesSection').style.display = 'block';
    const slideValues = optionsData.drawerSlides;
    const quantity = productData.drawerSlides?.quantity ?? 1;

    const cheapestPrice = Math.min(...Object.values(slideValues));

    Object.keys(slideValues).forEach(type => {
      const basePrice = slideValues[type];
      const diff = (basePrice - cheapestPrice) * quantity;
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.textContent = diff > 0
        ? `${type} (+RM${diff.toFixed(2)})`
        : `${type}`;
      btn.onclick = () => {
        selectedSlide = type;
        highlightSelection(container, btn);
        updatePrice();
        validateProceedButton();
      };
      container.appendChild(btn);
    });

    // Default select cheapest slide
    const cheapestSlide = Object.entries(slideValues).reduce((min, cur) => cur[1] < min[1] ? cur : min);
    selectedSlide = cheapestSlide[0];
    setTimeout(() => {
      const btns = container.querySelectorAll('.option-btn');
      btns.forEach(btn => {
        if (btn.textContent.startsWith(cheapestSlide[0])) btn.click();
      });
    }, 10);
  }

  function highlightSelection(container, btn) {
    container.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  function setDefaultSelections() {
    const firstTypeBtn = document.querySelector('#typeOptions .option-btn');
    if (firstTypeBtn) {
      firstTypeBtn.click();
    }
  }

  function updatePrice() {
    if (!selectedType || !selectedColor) return;

    let total = 0;
    const typeMaterials = productData[selectedType];

    for (const [matName, matData] of Object.entries(typeMaterials)) {
      if (matName.toLowerCase().includes('color')) continue;
      const basePrice = optionsData[matName]?.price ?? 0;
      const percentage = matData.price?.percentage ?? 0;
      total += basePrice * percentage / 100;
    }

    let colorGroupName = Object.keys(typeMaterials).find(k => k.toLowerCase().includes('color'));
    if (colorGroupName) {
      const colorPercent = typeMaterials[colorGroupName][selectedColor]?.percentage ?? 0;
      const baseColorPrice = optionsData.colors?.[colorGroupName]?.[selectedColor] ?? 0;
      total += baseColorPrice * colorPercent / 100;
    }

    if (productData.doorHinges && selectedHinge) {
      total += optionsData.doorHinges[selectedHinge] * productData.doorHinges.quantity;
    }

    if (productData.drawerSlides && selectedSlide) {
      total += optionsData.drawerSlides[selectedSlide] * productData.drawerSlides.quantity;
    }

    document.getElementById('price').textContent = total.toFixed(2);

    const msg = `Hi, I want to order ${productData.name}.\nMaterial Type: ${typeNameMap[selectedType] || selectedType}\nColor: ${selectedColor}\nHinges: ${selectedHinge || 'N/A'}\nSlides: ${selectedSlide || 'N/A'}\nPrice: RM ${total.toFixed(2)}`;
    const encoded = encodeURIComponent(msg);
    document.getElementById('whatsappBtn').href = `https://wa.me/601111213149?text=${encoded}`;
  }

  function updateMainImage(color) {
    const img = productData.images[color] || Object.values(productData.images)[0];
    const imageElement = document.getElementById('productImage');
    imageElement.style.opacity = 0;
    setTimeout(() => {
      imageElement.src = img;
      imageElement.style.opacity = 1;
    }, 200);
  }

  function validateProceedButton() {
    const proceedBtn = document.getElementById('whatsappBtn');
    const hingeRequired = productData.doorHinges ? !!selectedHinge : true;
    const slideRequired = productData.drawerSlides ? !!selectedSlide : true;

    if (selectedType && selectedColor && hingeRequired && slideRequired) {
      proceedBtn.classList.add('enabled');
      proceedBtn.removeAttribute('disabled');
    } else {
      proceedBtn.classList.remove('enabled');
      proceedBtn.setAttribute('disabled', 'true');
    }
  }

  // Store type name map for price message usage
  const typeNameMap = {
    'type 1': 'Blockboard + Formica',
    'type 2': 'Melamine Chipboard'
  };

  fetchData();
</script>

</body>
</html>
