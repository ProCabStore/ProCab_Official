<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Our Products</title>
  <style>
    /* CSS unchanged */
    :root {
      --color-background: #ffffff;
      --color-foreground: #f8f9fa;
      --color-text: #222;
      --color-secondary: #666;
      --color-primary: #007bff;
      --color-primary-hover: #0056b3;
      --color-border-subtle: #e9ecef;

      --font-family-sans-serif: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-weight-normal: 400;
      --font-weight-bold: 600;

      --transition-speed: 0.2s;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-family-sans-serif);
      font-size: 1rem;
      line-height: 1.5;
      color: var(--color-text);
      background-color: var(--color-background);
    }

    .category-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.8rem;
      background: var(--color-foreground);
      border-bottom: 1px solid var(--color-border-subtle);
    }

    .category-list button {
      background: #fff;
      border: 1px solid var(--color-border-subtle);
      border-radius: 18px;
      padding: 0.4rem 1rem;
      font-size: 0.85rem;
      color: var(--color-text);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .category-list button:hover,
    .category-list button.active {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }

    .product-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.8rem;
      padding: 1rem;
    }

    .product-card {
      background: #fff;
      border-radius: 6px;
      border: 1px solid var(--color-border-subtle);
      overflow: hidden;
      transition: transform 0.2s ease;
      cursor: pointer;
      flex: 1 1 150px;
      max-width: 150px;
      display: flex;
      flex-direction: column;
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .product-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background: #f3f3f3;
    }

    .product-info {
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .product-info h3 {
      font-size: 0.9rem;
      margin: 0;
      color: var(--color-text);
      font-weight: 500;
      line-height: 1.2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .product-info .colors {
      font-size: 0.75rem;
      color: var(--color-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-info p {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0.1rem 0 0;
      color: #000;
    }

    @media (min-width: 768px) {
      .product-card {
        flex: 1 1 220px;
        max-width: 220px;
      }

      .product-card img {
        height: 180px;
      }

      .product-info h3 {
        font-size: 1rem;
      }

      .product-info p {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="category-list" id="categoryList"></div>

  <div class="product-grid" id="productGrid"></div>

  <script>
    fetch('navbar.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('navbar-placeholder').innerHTML = data;
        const navbarToggle = document.getElementById('navbarToggle');
        const navbarMenu = document.getElementById('navbarMenu');
        if (navbarToggle && navbarMenu) {
          navbarToggle.addEventListener('click', () => {
            navbarToggle.classList.toggle('is-active');
            navbarMenu.classList.toggle('is-active');
          });
        }
      });

    let productsData = [];
    let optionsData = [];
    let currentCategory = 'all';

    async function fetchData() {
      const productsRes = await fetch('products.json');
      const optionsRes = await fetch('options.json');
      productsData = await productsRes.json();
      optionsData = await optionsRes.json();

      renderCategories(optionsData.categories);
      renderProducts(productsData, optionsData);
    }

    function calculateCheapestPrice(product, options) {
      let cheapestTypeCost = Infinity;

      for (const typeKey of ['type 1', 'type 2']) {
        if (!product[typeKey]) continue;

        const typeData = product[typeKey];
        let materialSum = 0;
        const colorGroups = [];

        // Sum all materials for this type
        for (const [key, value] of Object.entries(typeData)) {
          if (key.toLowerCase().includes('color')) {
            colorGroups.push(key);
            continue;
          }
          const basePrice = options[key]?.price ?? 0;
          const percentage = value.price?.percentage ?? 100;
          materialSum += (basePrice * percentage) / 100;
        }

        // Find cheapest color cost multiplied by its percentage
        let cheapestColorCost = Infinity;
        for (const colorGroupName of colorGroups) {
          const colors = typeData[colorGroupName];
          const baseColorPrices = options.colors?.[colorGroupName] || {};

          for (const [colorName, colorData] of Object.entries(colors)) {
            const baseColorPrice = baseColorPrices[colorName] ?? 0;
            const colorPercentage = colorData.percentage ?? 100;
            const colorCost = (baseColorPrice * colorPercentage) / 100;
            if (colorCost < cheapestColorCost) {
              cheapestColorCost = colorCost;
            }
          }
        }
        if (cheapestColorCost === Infinity) cheapestColorCost = 0;

        const totalTypeCost = materialSum + cheapestColorCost;

        if (totalTypeCost < cheapestTypeCost) {
          cheapestTypeCost = totalTypeCost;
        }
      }

      let hingeCost = 0;
      if (product.doorHinges?.quantity > 0) {
        const minHingePrice = Math.min(...Object.values(options.doorHinges));
        hingeCost = minHingePrice * product.doorHinges.quantity;
      }

      let slideCost = 0;
      if (product.drawerSlides?.quantity > 0) {
        const minSlidePrice = Math.min(...Object.values(options.drawerSlides));
        slideCost = minSlidePrice * product.drawerSlides.quantity;
      }

      return (cheapestTypeCost + hingeCost + slideCost).toFixed(2);
    }

    function renderCategories(categories) {
      const container = document.getElementById('categoryList');
      container.innerHTML = '';

      const allBtn = document.createElement('button');
      allBtn.textContent = 'All';
      allBtn.classList.add('active');
      allBtn.onclick = () => filterByCategory('all');
      container.appendChild(allBtn);

      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat;
        btn.onclick = () => filterByCategory(cat);
        container.appendChild(btn);
      });
    }

    function filterByCategory(category) {
      currentCategory = category;
      const buttons = document.querySelectorAll('.category-list button');
      buttons.forEach(btn => btn.classList.remove('active'));
      const activeBtn = [...buttons].find(btn => btn.textContent.toLowerCase() === (category === 'all' ? 'all' : category.toLowerCase()));
      if (activeBtn) activeBtn.classList.add('active');

      const filtered = category === 'all'
        ? productsData
        : productsData.filter(p => p.category.toLowerCase() === category.toLowerCase());

      renderProducts(filtered, optionsData);
    }

    function renderProducts(products, options) {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';

      products.forEach(product => {
        const cheapestPrice = calculateCheapestPrice(product, options);
        const firstImage = Object.values(product.images)[0] || 'https://via.placeholder.com/220x180?text=No+Image';

        const colorNames = new Set();
        ['type 1', 'type 2'].forEach(typeKey => {
          if (product[typeKey]) {
            for (const [key, val] of Object.entries(product[typeKey])) {
              if (key.toLowerCase().includes('color')) {
                Object.keys(val).forEach(color => colorNames.add(color));
              }
            }
          }
        });
        const uniqueColors = Array.from(colorNames);

        const colorDisplay = uniqueColors.length > 2
          ? `${uniqueColors.slice(0, 2).join(', ')} +${uniqueColors.length - 2} more`
          : uniqueColors.join(', ');

        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => {
          window.location.href = `product-detail.html?id=${product.id}`;
        };
        card.innerHTML = `
          <img src="${firstImage}" alt="${product.name}">
          <div class="product-info">
            <h3>${product.name}</h3>
            <div class="colors">${colorDisplay}</div>
            <p>RM ${cheapestPrice}</p>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    fetchData();
  </script>
</body>
</html>
