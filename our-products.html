<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Our Products</title>
  <style>
    :root {
      --color-background: #ffffff;
      --color-foreground: #f8f9fa;
      --color-text: #222;
      --color-secondary: #666;
      --color-primary: #007bff;
      --color-primary-hover: #0056b3;
      --color-border-subtle: #e9ecef;

      --font-family-sans-serif: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-weight-normal: 400;
      --font-weight-bold: 600;

      --transition-speed: 0.2s;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-family-sans-serif);
      font-size: 1rem;
      line-height: 1.5;
      color: var(--color-text);
      background-color: var(--color-background);
    }

    .category-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.8rem;
      background: var(--color-foreground);
      border-bottom: 1px solid var(--color-border-subtle);
    }

    .category-list button {
      background: #fff;
      border: 1px solid var(--color-border-subtle);
      border-radius: 18px;
      padding: 0.4rem 1rem;
      font-size: 0.85rem;
      color: var(--color-text);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .category-list button:hover,
    .category-list button.active {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }

    .product-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.8rem;
      padding: 1rem;
    }

    .product-card {
      background: #fff;
      border-radius: 6px;
      border: 1px solid var(--color-border-subtle);
      overflow: hidden;
      transition: transform 0.2s ease;
      cursor: pointer;
      flex: 1 1 150px;
      max-width: 150px;
      display: flex;
      flex-direction: column;
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .product-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background: #f3f3f3;
    }

    .product-info {
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .product-info h3 {
      font-size: 0.9rem;
      margin: 0;
      color: var(--color-text);
      font-weight: 500;
      line-height: 1.2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .product-info .colors {
      font-size: 0.75rem;
      color: var(--color-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-info p {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0.1rem 0 0;
      color: #000;
    }

    @media (min-width: 768px) {
      .product-card {
        flex: 1 1 220px;
        max-width: 220px;
      }

      .product-card img {
        height: 180px;
      }

      .product-info h3 {
        font-size: 1rem;
      }

      .product-info p {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="category-list" id="categoryList"></div>

  <div class="product-grid" id="productGrid"></div>

  <script>
    fetch('navbar.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('navbar-placeholder').innerHTML = data;
        const navbarToggle = document.getElementById('navbarToggle');
        const navbarMenu = document.getElementById('navbarMenu');
        if (navbarToggle && navbarMenu) {
          navbarToggle.addEventListener('click', () => {
            navbarToggle.classList.toggle('is-active');
            navbarMenu.classList.toggle('is-active');
          });
        }
      });

    let productsData = [];
    let optionsData = [];
    let currentCategory = 'all';

    async function fetchData() {
      const productsRes = await fetch('products.json');
      const optionsRes = await fetch('options.json');
      productsData = await productsRes.json();
      optionsData = await optionsRes.json();

      renderCategories(optionsData.categories || []);
      renderProducts(productsData, optionsData);
    }

    function getPercentage(value) {
      if (typeof value === 'number') return value;
      if (value?.percentage) return value.percentage;
      if (value?.price?.percentage) return value.price.percentage;
      return 100;
    }

    function calculateCheapestPrice(product, options) {
      let basePrice = 0;
      let chosenType = null;
      let chosenColor = null;

      // Calculate base price (materials + colors)
      const typeKeys = Object.keys(product).filter(k => k.toLowerCase().startsWith('type'));
      
      typeKeys.forEach(typeKey => {
        const typeData = product[typeKey];
        let typePrice = 0;

        // Material costs
        Object.keys(typeData).forEach(materialKey => {
          if (materialKey.toLowerCase().includes('color')) return;

          const materialPrice = options.material?.[materialKey]?.price || 0;
          const percentage = getPercentage(typeData[materialKey]);
          typePrice += (materialPrice * percentage) / 100;
        });

        // Color costs
        Object.keys(typeData).forEach(colorGroupKey => {
          if (!colorGroupKey.toLowerCase().includes('color')) return;

          const colorOptions = options.colors?.[colorGroupKey] || {};
          const colorData = typeData[colorGroupKey];
          let cheapestColorPrice = Infinity;

          Object.keys(colorData).forEach(colorKey => {
            const colorValue = colorData[colorKey];
            let colorPrice = 0;

            if (Array.isArray(colorValue)) {
              colorValue.forEach(part => {
                const partPercentage = getPercentage(part);
                const partColor = part.color || colorKey;
                const partBasePrice = colorOptions[partColor] || 0;
                colorPrice += (partBasePrice * partPercentage) / 100;
              });
            } else {
              const percentage = getPercentage(colorValue);
              const basePrice = colorOptions[colorKey] || 0;
              colorPrice = (basePrice * percentage) / 100;
            }

            if (colorPrice < cheapestColorPrice) {
              cheapestColorPrice = colorPrice;
            }
          });

          if (cheapestColorPrice !== Infinity) {
            typePrice += cheapestColorPrice;
          }
        });

        if (typePrice > 0 && (basePrice === 0 || typePrice < basePrice)) {
          basePrice = typePrice;
          chosenType = typeKey;
        }
      });

      // Calculate accessories
      let accessoriesPrice = 0;
      Object.keys(product).forEach(accessoryKey => {
        const accessoryData = product[accessoryKey];
        if (!accessoryData || typeof accessoryData !== 'object' || !('quantity' in accessoryData)) return;

        const accessoryOptions = options.accessory?.[accessoryKey] || {};
        let cheapestOptionPrice = Infinity;

        Object.keys(accessoryData).forEach(optionKey => {
          if (optionKey === 'quantity' || accessoryData[optionKey] !== true) return;
          const optionPrice = accessoryOptions[optionKey] || 0;
          if (optionPrice < cheapestOptionPrice) {
            cheapestOptionPrice = optionPrice;
          }
        });

        if (cheapestOptionPrice !== Infinity) {
          accessoriesPrice += cheapestOptionPrice * accessoryData.quantity;
        }
      });

      return {
        price: (basePrice + accessoriesPrice).toFixed(2),
        type: chosenType,
        color: chosenColor
      };
    }

    function renderCategories(categories) {
      const container = document.getElementById('categoryList');
      container.innerHTML = '';

      const allBtn = document.createElement('button');
      allBtn.textContent = 'All';
      allBtn.classList.add('active');
      allBtn.onclick = () => filterByCategory('all');
      container.appendChild(allBtn);

      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat;
        btn.onclick = () => filterByCategory(cat);
        container.appendChild(btn);
      });
    }

    function filterByCategory(category) {
      currentCategory = category;
      const buttons = document.querySelectorAll('.category-list button');
      buttons.forEach(btn => btn.classList.remove('active'));
      const activeBtn = [...buttons].find(btn => btn.textContent.toLowerCase() === (category === 'all' ? 'all' : category.toLowerCase()));
      if (activeBtn) activeBtn.classList.add('active');

      const filtered = category === 'all'
        ? productsData
        : productsData.filter(p => p.category.toLowerCase() === category.toLowerCase());

      renderProducts(filtered, optionsData);
    }

    function renderProducts(products, options) {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';

      products.forEach(product => {
        const priceInfo = calculateCheapestPrice(product, options);
        const firstImage = Object.values(product.images)[0] || 'https://via.placeholder.com/220x180?text=No+Image';

        const colorNames = new Set();
        ['type 1', 'type 2'].forEach(typeKey => {
          if (product[typeKey]) {
            for (const [key, val] of Object.entries(product[typeKey])) {
              if (key.toLowerCase().includes('color')) {
                Object.keys(val).forEach(color => colorNames.add(color));
              }
            }
          }
        });

        const uniqueColors = Array.from(colorNames);
        const colorDisplay = uniqueColors.length > 2
          ? `${uniqueColors.slice(0, 2).join(', ')} +${uniqueColors.length - 2} more`
          : uniqueColors.join(', ');

        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => {
          window.location.href = `product-detail.html?id=${product.id}`;
        };
        card.innerHTML = `
          <img src="${firstImage}" alt="${product.name}">
          <div class="product-info">
            <h3>${product.name}</h3>
            <div class="colors">${colorDisplay}</div>
            <p>RM ${priceInfo.price}</p>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    fetchData();
  </script>
</body>
</html>

